---
title: "Métodos Computacionales para las Ciencias Sociales"
subtitle: "Extracción de información web"  
author: 
  - "Klaus Lehmann"
output:
  xaringan::moon_reader:
    css: xaringan-themer2.css
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: github
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
  fig.retina=3,
  out.width = "70%",
  cache = FALSE,
  echo = T,
  message = FALSE, 
  warning = FALSE,
  hiline = TRUE
)
options(scipen = 999)
```

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
library(tidyverse)
library(DT)
library(kableExtra)
library(plotly)
library(readr)
#style_duo_accent(
#  primary_color = "#1381B0",
#  secondary_color = "#FF961C",
#  inverse_header_color = "#FFFFFF"
#)
xaringanExtra::use_panelset()

```

## Contenidos de la clase

Uso de APIs para las ciencias sociales

*Web scraping* para ~~la vida~~ las ciencias sociales 


---

## Produciendo datos

.pull-left[

<img src="imagenes/ferrari.jpg" width="500" />
]

--

.pull-right[

<img src="imagenes/tractor.jpg" width="600" />
]

---

## Produciendo datos

gratis != fácil

--

Las fuentes de datos no tradicionales y/o web muchas veces implican un arduo trabajo de captura y procesamiento

--

Debemos entrenarnos para ser buenos productores de información

--

Veremos 2 estrategias para recoger información

- Manejo de APIs
- *web scraping*

### No debemos asustarnos si nos encontramos con tecnologías que no conocemos bien

---

## Formatos y tecnologías de la web

.pull-left[

<img src="imagenes/ejemplo_json.png" width="450" />

<img src="imagenes/ejemplo_xml.png" width="250" />

]

.pull-right[

<img src="imagenes/ejemplo_html.png" width="200" />

<img src="imagenes/ejemplo_css.jpg" width="300" />

]

---

class: inverse center middle

# APIs


---

## ¿Qué es un API?

*Application programming interface* (interfaz de programación de aplicaciones)

--

Pieza de código que comunica 2 aplicaciones o sistemas

--

.center[
<img src="imagenes/puente.jpeg" width="300" />
]

Una API nos permite acceder a datos, sin enterarnos de la implementación que hay detrás

- ¿SQL?
- ¿Grafos?
- ¿mongodb?

*No nos importa*

---

## Características de una API

Recibe una petición (*request*) y devuelve una respuesta estructurada

La API manda al servidor la solicitud

Generalmente, la respuesta es un archivo json (ahondaremos en esto después)

--

Métodos más comunes:

- GET: obtener recurso
- POST: crear recurso o enviar datos
- PUT: actualizar recurso
- PATCH: actualizar recurso
- DELETE: eliminar recurso

--

Nosotros solo utilizaremos GET y POST

---

## Ejemplo de un request



.panelset[
.panel[.panel-name[curl]

Hacer *requests* correctamente implica conocer algunos protocolos

Estamos pidiendo todos los discos de Bruno Mars desde Spotify, usando curl desde la terminal


```{r, eval=F}
curl --request GET \
--url https://api.spotify.com/v1/artists/0du5cEVh5yTK9QJze8zA0C/albums \
--header 'Authorization: Bearer BQDV6qbwbL...AYc3Wja1fhyXVfbDZhnwGwXiSM4l1FZw7UoN12YtmSf0omuuBbH_rttJ7uzhFMuY'
```

]

.panel[.panel-name[httr]

En R podemos usar un paquete llamado httr, pero sigue siendo complejo 


```{r, eval=F}
by_httr <- GET(url = "https://api.spotify.com/v1/artists/0du5cEVh5yTK9QJze8zA0C/albums", 
             add_headers(Authorization="Bearer BQDV6qbwbLcun5HK6asPqYRWzvA....7UoN12YtmSf0omuuBbH_rttJ7uzhFMuY")
)
```


]


.panel[.panel-name[spotifyr]

Afortunadamente, hay personas que han construído paquetes 😁

```{r, eval=FALSE}
bruno_mars <- get_artist_albums(id = "0du5cEVh5yTK9QJze8zA0C")
```

Nos centraremos en esta estrategia

En la vida real tendrán que aprender APIs desde 0

]

]


---

## Algunas APIs para las ciencias sociales

En este [bookdown](https://bookdown.org/paul/apis_for_social_scientists) se describen varias APIs y aplicaciones para las ciencias sociales

Algunos ejemplos:

- youtube
- google news
- twitter
- spotify
- google places

--

Revisaremos en detalle spotify y twitter

En la unidad de datos geoespaciales revisaremos *google places*


---

class: inverse center middle

# spotify

---

## Primeros pasos

[Pasos](https://developer.spotify.com/documentation/web-api) a seguir

1. Crear una cuenta en spotify (gratis o pagada)
2. Entrar a [spotify for developers](https://developer.spotify.com) 
3. Ir a la sección *dashboard* y crear una aplicación 
4. Dentro de la aplicación, ir a *settings* y buscar las credenciales (client id y client secret)

--

### Ahora podemos empezar a descargar datos

---

## Primeros pasos

```{r, eval=FALSE}
install.packages("spotifyr")
```

--

Con nuestras credenciales debemos activar un *token* que dura **una hora**

```{r crear token}
library(spotifyr)
#Crear token a partir de las credenciales
access_token <- get_spotify_access_token(client_id = Sys.getenv("SPOTIFY_CLIENT_ID"), 
                                         client_secret = Sys.getenv("SPOTIFY_CLIENT_SECRET"))
```

--

**Comentario al margen**

- Nunca deben escribir explícitamente sus credenciales en el código
- Una alternativa es usar variables de ambiente

---
## Identificadores spotify

Las APIs suelen funcionar con un sistema de identificadores:

- álbum
- artista
- mercado
- episodios

Podemos ver el id de un artista mediante la aplicación de escritorio

.center[
<img src="imagenes/spotify_logo.png" width="300" />
]

---

## Discos de Bruno Mars

```{r}
bruno_albums <-  get_artist_albums("0du5cEVh5yTK9QJze8zA0C")
```

```{r, echo=FALSE}
bruno_albums %>% 
  select(album_type, id, name, total_tracks) %>% 
  datatable(options = list(pageLength = 5, dom = "p") )
```


---

## Exploremos Unorthodox Jukebox

```{r}
jukebox <-  get_album_tracks("58ufpQsJ1DS5kq4hhzQDiI") # id del álbum
```

```{r, echo=FALSE}
jukebox %>% 
  select(duration_ms, id, name ) %>% 
  datatable(options = list(pageLength = 5, dom = "p") )
```

---

## Exploremos treasure

La API nos devuelve características del *track*

```{r}
treasure <- get_track_audio_features("55h7vJchibLdUkxdlX3fK7")
```

```{r, echo=FALSE}
treasure %>% 
  select(-c("id", "uri", "analysis_url", "time_signature", "track_href", "type") ) %>% 
  datatable(options = list(pageLength = 5, dom = "p") )

```

---

## Discografía completa

Todos los *tracks* de *Foo Fighters*, *Shakira* y *Slayer*

```{r shakira-foo-slayer}
foo_fighters <-  get_artist_audio_features("7jy3rLJdDQY21OgRLCZ9sD", include_groups = "album")
shakira <-  get_artist_audio_features("0EmeFodog0BfCgMzAIvKQp", include_groups = "album")
slayer <-  get_artist_audio_features("1IQ2e1buppatiN1bxUVkrk", include_groups = "album")
full <- bind_rows(foo_fighters, shakira, slayer)
```

```{r plot slayer, echo=FALSE, fig.height=5}

plot <- full %>% 
  group_by(artist_name) %>% 
  summarise_at(.vars = c("energy", "valence", "danceability"), .funs = mean ) %>% 
  pivot_longer(cols = c("energy", "valence", "danceability"), names_to = "indicator", values_to = "value") %>% 
  ggplot(aes(x = artist_name, y = value, fill = indicator )) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_bw() +
  theme(axis.title = element_blank())

ggplotly(plot)
```


---

## Explorando géneros

La función `get_genre_artists` permite hacer búsquedas con ciertos criterios

- género
- mercado

--

Es muy importante el sistema de **paginación**

--

En general, las APIs tienen mecanismos para no solicitar toda la información en una sola llamada

- limit: número de respuestas que queremos (máximo = 50)
- offset: índice desde el cual queremos partir (máximo = 1.000)


```{r}
bandas_chilenas1 <-  get_genre_artists(genre = "rock", market = "CL", limit = 5, offset = 0) # 0 al 4  
bandas_chilenas2 <-  get_genre_artists(genre = "rock", market = "CL", limit = 5, offset = 5) # 5 al 9  
```

--

Cuando sobrepasamos el 1.000, obtenemos un error

```{r, error=TRUE}
final <-  get_genre_artists(genre = "rock", market = "CL", limit = 2, offset = 1) # 999 + 2 = 1001  
```


---

## Discos de rock en Chile

Vamos a descargar todos los discos de rock dentro del mercado chileno

--

Debemos seguir varios pasos:

1. Buscar los identificadores de las bandas
2. Limpiar la lista de bandas
3. Usar los identificadores, para buscar la discografía de cada banda

--

El paso 1 lo harán ustedes

--

Los pases 2 y 3 los haremos en conjunto


---
## Discos de rock en Chile: paso 1

Utilizando el sistema de paginación, descarga toda las bandas de rock que participan en el mercado chileno

Deberías usar un *loop* para iterar sobre una secuencia de *offsets*

Almacenar la información en una lista puede ser buena idea

*Pista:* Podría servirles esta secuencia

```{r}
secuencia <-  seq(0, 950, 50)
```


```{r}

# Bonus track: podemos resolverlo con map de manera muy compacta
bandas_rock_df <- map(secuencia, ~get_genre_artists(genre = "rock", market = "CL", limit = 50, offset = .x)) %>% 
  bind_rows()
```


---

## Discos de rock en Chile: paso 2

Nos gustaría aproximarnos a las bandas chilenas

Podemos usar la popularidad como un *proxy*


```{r}
chilenas <-  bandas_rock_df %>% 
  arrange(popularity) %>% 
  slice(1:100) %>% 
  pull(id)
  
```

Ahora buscamos la discografía para todas estas bandas

```{r, eval=FALSE}
discografia <-  map(chilenas,  ~get_artist_audio_features(.x, include_groups = "album")) %>% 
  bind_rows()

write_csv(discografia, "data/bandas_chilenas.csv")



```

```{r leer bandas }
discografia <- read_csv("data/bandas_chilenas.csv")
caracteristicas <-  discografia %>% 
  group_by(album_release_year) %>%
  summarise_at(.vars = c("danceability", "energy", "valence", "tempo"), .funs =  mean)

n_discos <- discografia %>% 
  group_by(album_release_year, album_id) %>% 
  slice(1) %>%
  group_by(album_release_year) %>% 
  summarise(n = n())

n_discos %>% 
  ggplot(aes(x = album_release_year, n, group = 1)) +
  geom_line()

```

---
## 

---

## En resumen

Spotify es un caso particular de uso de APIs

La idea es aprender la mecánica de las APIs

---

## En conclusión

Hemos aprendido 

---


```{r}
#access_token

# curl --request GET \
#   --url 'https://api.spotify.com/v1/search?q=genre%3Arock&type=artist&market=CL&limit=2' \
#   --header 'Authorization: Bearer BQAGYF-Hpx948A6IqmreUmmFb5RCPh-iTVwLXCvWe5aFhr6h-dTpph9nB89Elo9O9XeXXwTmZ8RwoGYmkkgGCEoOx7qj9dgeoQeVSsgwueaQvpM3oHA'


# data <- GET(url = 'https://api.spotify.com/v1/search?q=genre%3Arock&type=artist&market=CL&limit=9&offset=991',
#     add_headers(Authorization="Bearer BQAGYF-Hpx948A6IqmreUmmFb5RCPh-iTVwLXCvWe5aFhr6h-dTpph9nB89Elo9O9XeXXwTmZ8RwoGYmkkgGCEoOx7qj9dgeoQeVSsgwueaQvpM3oHA"))
#library(jsonlite)
# res <- fromJSON(content(data, as = "text", encoding = "UTF-8"), flatten = TRUE)
# artists <- res$artists
# artists$items$name
```


---

---
class: center, middle

## Métodos Computacionales para las Ciencias Sociales

### Hasta la próxima clase


